---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

Start by cleaning the data. Taking only ani depressants.
Removing all use of medication prior to index day.
Then do hazard analysis with age (make categorical, gender, marital statues, comorbidity)

```{r}
# load data
library(tidyverse)
library(jtools)
vaDat <- read_csv('/home/or/Dropbox/postdoc/Yale/va_data/MED_Drop.csv')

vaDatclean <- vaDat
# remove more than 365 psychotherapies
vaDatclean$MHTOTALLc <- ifelse((vaDatclean$MHTOTALL > 365), (vaDatclean$MHTOTALLc = 365), (vaDatclean$MHTOTALLc = vaDatclean$MHTOTALL))

# set index date
a = '01/01/1960'
vaDatclean$PTSDINDr = as.Date(as.character(a), format = '%d/%m/%Y') + vaDatclean$PTSDIND
# Now take only patients who recieved medications. 
onlyMed_dat <- subset(vaDatclean, vaDatclean$PMEDRX==1)
# set number of days from index day to drop out
vaDatclean$totalDays <- as.Date(as.character(vaDatclean$MHDROPD),format = '%m/%d/%Y')  - as.Date(vaDatclean$PTSDINDr,format = '%Y/%m/%d')
head(vaDatclean)
```
```{r}
# create a few variables before stratification
# Race
vaDatclean$race <- dplyr::case_when(vaDatclean$BLACK==1 ~ "Black",vaDatclean$WHITE==1 ~ "White", vaDatclean$HISPANIC==1 ~ "Hispanic", vaDatclean$ASIAN ==1 ~ "Asian", TRUE ~ "Other")
vaDatclean$race <- factor(vaDatclean$race)
# change levels white will be first
vaDatclean$race <- relevel(vaDatclean$race, "White")

# turn age to categorical
vaDatclean$ageCat <- cut(vaDatclean$AGE_OCT01, breaks = c(15, 25, 35, 45, 60, 90), labels = c("18-25", "26-35", "36-45", "45-60", "60+"))
plot(vaDatclean$ageCat)
# check comorbidity
vaDatclean$sumComorbid <- vaDatclean$DEMENT_ALZ + vaDatclean$ALC + vaDatclean$DRUG + vaDatclean$SCHIZOPHRENIA + vaDatclean$OTHERPSYCHOSIS + vaDatclean$BIPOLAR + vaDatclean$MAJORAFFECT + vaDatclean$OTHERDEP + vaDatclean$ANXIETY + vaDatclean$ADJUSTMENT + vaDatclean$PERSONALITY + vaDatclean$BORDERLINE
#antiDP_dat$comorbid <- dplyr::case_when(antiDP_dat$DEMENT_ALZ!=0 ~ "Dementia", antiDP_dat$ALC !=0 ~"Alcohol", )
vaDatclean$MARRIED <- factor(vaDatclean$MARRIED)

vaDatclean$FEMALE <- factor(vaDatclean$FEMALE)
vaDatclean$VATXM <- factor(vaDatclean$VATXM) #, labels = c("Yes", "No"))
# Creating Psychotherapy 0 - none or 1 = exist
vaDatclean$PSYCTR <- dplyr::case_when(vaDatclean$INDPSY >1 | vaDatclean$GRPPSY >1 | vaDatclean$FAMPSY >1 ~ "yes", TRUE ~ "no")
vaDatclean$PSYCTR <- factor(vaDatclean$PSYCTR)

vaDatclean$sumComorbidfactor <- cut(vaDatclean$sumComorbid, breaks = c(-1,0,1,3,15), labels = c("0","1", "2-3","3+"))
plot(vaDatclean$sumComorbidfactor)

vaDatclean$ANXfactor <- factor(vaDatclean$ANXIETY)
vaDatclean$URBAN_RURAL <- factor(vaDatclean$URBAN_RURAL)
vaDatclean$MAJORAFFECT <- factor(vaDatclean$MAJORAFFECT)

vaDatclean$race <- factor(vaDatclean$race)
vaDatclean$OEFOIF <- factor(vaDatclean$OEFOIF)

vaDatclean$ADRXN_true <- case_when(vaDatclean$ADRXN > 0 ~ 1, TRUE ~0)
vaDatclean$APSRXN_true <- case_when(vaDatclean$APSRXN >0 ~ 1, TRUE ~0)
vaDatclean$AXSEDHPRXN_true <- case_when(vaDatclean$AXSEDHPRXN >0 ~ 1, TRUE ~0)
vaDatclean$STIMRXN_true <- case_when(vaDatclean$STIMRXN > 0 ~ 1, TRUE ~ 0)
vaDatclean$ACVMSRXN_true <- case_when(vaDatclean$ACVMSRXN > 0 ~ 1, TRUE ~ 0)
vaDatclean$LIRXN_true <- case_when(vaDatclean$LIRXN > 0 ~ 1, TRUE ~ 0)

vaDatclean$sumMed <- vaDatclean$LIRXN_true + vaDatclean$ACVMSRXN_true + vaDatclean$STIMRXN_true + vaDatclean$AXSEDHPRXN_true + vaDatclean$APSRXN_true + vaDatclean$ADRXN_true 
vaDatclean$sumMedCat <- factor(case_when(vaDatclean$sumMed==1 ~ '1', vaDatclean$sumMed == 2 ~ "2", vaDatclean$sumMed >= 3 ~ "3+"))

# create a censore variable who survived more than 30 days
vaDatclean$MONTH1 <- case_when(vaDatclean$totalDays <= 30 ~ 1, TRUE ~ 0)

```

Lets take just medicated patients, before stratify to different groups of medication.
```{r}
# take just medicated patients. 
medicatedVa_dat <- filter(vaDatclean, PMEDRX==1)
head(medicatedVa_dat)
```
Lets look at some descriptives
```{r}
# plot age
ggplot(medicatedVa_dat, aes(x=medicatedVa_dat$AGE_OCT01)) + geom_histogram() + xlab("Age") + stat_bin(bins=30) + theme_minimal() + ggtitle("Age Histogram")
summary(medicatedVa_dat$MARRIED)
table(medicatedVa_dat$FEMALE)
plot(medicatedVa_dat$race)
g <- data.frame(table(medicatedVa_dat$race))
plot(g)
table(g)
ggplot(g, aes(x= "",y=Freq, fill = Var1)) + geom_bar(width = 14, stat = "identity") + coord_polar("y") + theme_minimal()
table(medicatedVa_dat$sumMed)
```


```{r}
# now we clean data
# take only anti depressant without any medication before index day
antiDP_dat <- dplyr::filter(vaDatclean, !is.na(ADRXN) & is.na(PREADRX) & is.na(PREAPRX) & is.na(PREAXRX) & is.na(PRESTIRX) & is.na(PREACRX) & is.na(PRELIRX) & is.na(PREOPRX) & is.na(PREPRZRX)) 
head(antiDP_dat)

```

Now lets look at the drugs

```{r}
# whats the average drug usage?
drugeUsage<- table(medicatedVa_dat$ADDAY)#, antiDP_dat$APSDAY, antiDP_dat$AXDAY, vaDatclean$STIMDAY)
hist(medicatedVa_dat$MEDTOTDAY)
# many patients drop out fast.
# lets see how many we have after 30 days of use
drugeMore30 <- filter(medicatedVa_dat, MEDTOTDAY >= 30)
247083/330772
# only 74.6% of the people survive the first 30 days. 
hist(drugeMore30$ADDAY)

drugLess30 <- filter(medicatedVa_dat, MEDTOTDAY  <= 30)
mean(medicatedVa_dat$ADDAY, na.rm=TRUE)
sd(antiDP_dat$ADDAY)
median(medicatedVa_dat$ADDAY, na.rm=TRUE)
plot(density(medicatedVa_dat$ADDAY, na.rm=TRUE) )
```

So - after 30 days we see major drop out. We will start by focusing on that time period. 
```{r}
# first create survival model
library(survival)
library(survminer)
surv_less30 <- Surv(time = medicatedVa_dat$MEDTOTDAY, event = medicatedVa_dat$MONTH1)  
summary(surv_less30)
# now cox analysis
fit.coxphLess30 <- coxph(surv_less30 ~ FEMALE  + PSYCTR + MARRIED + ageCat + race + sumComorbid + sumMed, 
                   data = medicatedVa_dat)
ggforest(fit.coxphLess30, data = medicatedVa_dat)
```

```{r}
model30 <- glm(MONTH1 ~ scale(PSYCTHR) + MARRIED + scale(medicatedVa_dat$AGE_OCT01) + race + scale(medicatedVa_dat$sumComorbid) + scale(sumMed), data = medicatedVa_dat)
summary(model30)
summ(model30, exp = TRUE)
plot
```


So. average use of anti depressant is 101.9 days. SD is 111 and median is 61. 


Cleaning to anti dperessant and removing any patient with pre subscribed drug (before index day). We now have 151,131 patients. 
Now we should create age and comorbid categorical variables. 
```{r}
plot(antiDP_dat$ageCat)
```

Now lets do survival analysis

```{r}
surv_object <- Surv(time = antiDP_dat$MEDTOTDAY, event = antiDP_dat$MHDROP)
summary(surv_object)
```


```{r}
# fitting
fit1 <- survfit(surv_object ~ antiDP_dat$VATXM, data = antiDP_dat) # fit the analysis with gender
#summary(fit1)
ggsurvplot(fit1, data = antiDP_dat, pval = TRUE)
```
Seems like VAXTM is very good. Lets do hazard analysis. 

```{r}
# Hazard analysis
fit.coxph1 <- coxph(surv_object ~ FEMALE  + VATXM + MARRIED + ageCat, 
                   data = antiDP_dat)
ggforest(fit.coxph1, data = antiDP_dat)
```

Now we should add comorbidity

```{r}
plot(antiDP_dat$sumComorbidfactor)
```

```{r}
fit.coxph2 <- coxph(surv_object ~ FEMALE  + VATXM + MARRIED + ageCat + sumComorbidfactor, 
                   data = antiDP_dat)
ggforest(fit.coxph2, data = antiDP_dat)
```
Lets check only with Anxiety disorder.

```{r}
######################################################################
######################################################################
############### ANALYSIS ANTI DEPRESSANTS #################
fit.coxph3 <- coxph(surv_object ~ FEMALE  + PSYCTR + MARRIED + OEFOIF + race + sumComorbidfactor, 
                   data = antiDP_dat)
ggforest(fit.coxph3, data = antiDP_dat)
```


Check what happens with more than one medication:
```{r}
antiDP_dat$ADRXN_true <- case_when(antiDP_dat$ADRXN > 0 ~ 1, TRUE ~0)
antiDP_dat$APSRXN_true <- case_when(antiDP_dat$APSRXN >0 ~ 1, TRUE ~0)
antiDP_dat$AXSEDHPRXN_true <- case_when(antiDP_dat$AXSEDHPRXN >0 ~ 1, TRUE ~0)
antiDP_dat$STIMRXN_true <- case_when(antiDP_dat$STIMRXN > 0 ~ 1, TRUE ~ 0)
antiDP_dat$ACVMSRXN_true <- case_when(antiDP_dat$ACVMSRXN > 0 ~ 1, TRUE ~ 0)
antiDP_dat$LIRXN_true <- case_when(antiDP_dat$LIRXN > 0 ~ 1, TRUE ~ 0)

antiDP_dat$sumMed <- antiDP_dat$LIRXN_true + antiDP_dat$ACVMSRXN_true + antiDP_dat$STIMRXN_true + antiDP_dat$AXSEDHPRXN_true + antiDP_dat$APSRXN_true + antiDP_dat$ADRXN_true 
antiDP_dat$sumMedCat <- factor(case_when(antiDP_dat$sumMed==1 ~ '1', antiDP_dat$sumMed == 2 ~ "2", antiDP_dat$sumMed >= 3 ~ "3+"))

```

```{r}
### Including more than one medication ####
fit.coxph4 <- coxph(surv_object ~ FEMALE  + VATXM + MARRIED + OEFOIF + race + sumComorbidfactor + sumMedCat, 
                   data = antiDP_dat)
ggforest(fit.coxph4, data = antiDP_dat)
```

```{r}
antiDP_dat$APSRXN_trueMore <- factor(case_when(antiDP_dat$APSRXN >1 ~ 1, TRUE ~0))
antiDP_dat$AXSEDHPRXN_trueMore <- factor(case_when(antiDP_dat$AXSEDHPRXN >1 ~ 1, TRUE ~0))
### Including more than one medication ####
fit.coxph5 <- coxph(surv_object ~ FEMALE  + VATXM + MARRIED + OEFOIF + race + sumComorbidfactor + APSRXN_trueMore + AXSEDHPRXN_trueMore, 
                   data = antiDP_dat)
ggforest(fit.coxph5, data = antiDP_dat)
```





Lets check MHFUFRST. First meeting after index day
```{r}
# many NA in first visit after index day.
antiDP_dat_noMFirstNA <- subset(antiDP_dat, !is.na(antiDP_dat$MHFUFRST))
median(antiDP_dat_noMFirstNA$MHFUFRST)
# lets create a median split groups
antiDP_dat_noMFirstNA$firstV <- factor(case_when(antiDP_dat_noMFirstNA$MHFUFRST<=30 ~ "Low_Waiting", antiDP_dat_noMFirstNA$MHFUFRST>30 ~ "High_Waiting"))
plot(antiDP_dat_noMFirstNA$firstV)
```
Now we will create a new analysis, only on this data set. 
```{r}
surv_object_clean <- Surv(time = antiDP_dat_noMFirstNA$MEDTOTDAY, event = antiDP_dat_noMFirstNA$MHDROP)
summary(surv_object)
fitClean1<-survfit(surv_object_clean ~ antiDP_dat_noMFirstNA$firstV, data = antiDP_dat_noMFirstNA) # fit the analysis with gender
#summary(fit1)
ggsurvplot(fitClean1, data = antiDP_dat_noMFirstNA, pval = TRUE)
```

```{r}
antiDP_dat_noMFirstNA$firstV <- factor(antiDP_dat_noMFirstNA$firstV)
fit.coxphClean <- coxph(surv_object_clean ~ FEMALE  + VATXM + MARRIED + ageCat + race + firstV, 
                   data = antiDP_dat_noMFirstNA)
ggforest(fit.coxphClean, data = antiDP_dat_noMFirstNA)
```

Lets check what happens if we cut after 120 days. 
```{r}
# create new timevar with maximum of 120 days
antiDP_dat_noMFirstNA$MEDTOTDAY_max120 <- case_when(antiDP_dat_noMFirstNA$MEDTOTDAY>= 120 ~ 120, TRUE ~ antiDP_dat_noMFirstNA$MEDTOTDAY)
surv_object_120 <- Surv(time = antiDP_dat_noMFirstNA$MEDTOTDAY_max120, event = antiDP_dat_noMFirstNA$MONTH4)
summary(surv_object_120)
```
```{r}
fit.coxph120 <- coxph(surv_object_120 ~ FEMALE  + VATXM + MARRIED + ageCat + race + firstV, 
                   data = antiDP_dat_noMFirstNA)
ggforest(fit.coxph120, data = antiDP_dat_noMFirstNA)
```

Now lets go for the median (i.e. 60 days)
```{r}
antiDP_dat_noMFirstNA$MEDTOTDAY_max60 <- case_when(antiDP_dat_noMFirstNA$MEDTOTDAY>= 60 ~ 60, TRUE ~ antiDP_dat_noMFirstNA$MEDTOTDAY)
surv_object_60 <- Surv(time = antiDP_dat_noMFirstNA$MEDTOTDAY_max60, event = antiDP_dat_noMFirstNA$MONTH2)
summary(surv_object_60)
```

```{r}
fit.coxph60 <- coxph(surv_object_60 ~ FEMALE  + VATXM + MARRIED + ageCat + race + firstV + MAJORAFFECT, 
                   data = antiDP_dat_noMFirstNA)
ggforest(fit.coxph60, data = antiDP_dat_noMFirstNA)
```

```{r}
head(pclNoNa)

```

```{r}
# create five factor pcl scores
# 1-5 Reexpirienceing (R)
# 6-7 avoidance (A)
# 8-12 emotional numbing (N)
# 13-15 disphoric arousal (DA)
# 16-17 Anxios arousal (AA)
pclNoNa$pclR <- pclNoNa$PCL1 + pclNoNa$PCL2 + pclNoNa$PCL3 + pclNoNa$PCL4 + pclNoNa$PCL5
pclNoNa$pclA <- pclNoNa$PCL6 + pclNoNa$PCL7
pclNoNa$pclN <- pclNoNa$PCL8 + pclNoNa$PCL9 + pclNoNa$PCL10 + pclNoNa$PCL11 + pclNoNa$PCL12
pclNoNa$pclDA <- pclNoNa$PCL13 + pclNoNa$PCL14 + pclNoNa$PCL15
pclNoNa$pclAA <- pclNoNa$PCL16 + pclNoNa$PCL17
pclNoNa$catpclR <- case_when(pclNoNa$pclR < median(pclNoNa$pclR, na.rm = TRUE) ~ "Low Rex", TRUE ~ "High Rex")
pclNoNa$catpclA <- case_when(pclNoNa$pclA < median(pclNoNa$pclA, na.rm = TRUE)~ "Low A", TRUE ~ "High A")
pclNoNa$catpclN <- case_when(pclNoNa$pclN < median(pclNoNa$pclN, na.rm = TRUE)~ "Low N", TRUE ~ "High N")
pclNoNa$catpclDA <- case_when(pclNoNa$pclDA < median(pclNoNa$pclDA, na.rm = TRUE)~ "Low Da", TRUE ~ "High DA")
pclNoNa$catpclAA <- case_when(pclNoNa$pclAA < median(pclNoNa$pclAA, na.rm = TRUE)~ "Low AA", TRUE ~ "High AA")
table(pclNoNa$catpclR)
```


```{r}
ggplot(pclNoNa, aes(x=pclNoNa$pclR, y= pclNoNa$MEDTOTDAY)) + geom_smooth() 
cor.test(pclNoNa$pclAA, pclNoNa$MEDTOTDAY)
```
```{r}
surv_objectPCL <- Surv(time = pclNoNa$MEDTOTDAY, event = pclNoNa$MHDROP)
summary(surv_objectPCL)
```
```{r}
# do hazard analysis using PCL R category
pclNoNa$catpclR <- factor(pclNoNa$catpclR)
pclNoNa$catpclN <- factor(pclNoNa$catpclN)
pclNoNa$catpclA <- factor(pclNoNa$catpclA)
pclNoNa$catpclDA <- factor(pclNoNa$catpclDA)
pclNoNa$catpclAA <- factor(pclNoNa$catpclAA)
fit.coxphPCL <- coxph(surv_objectPCL ~ FEMALE  + VATXM + MARRIED + ageCat + race  + MAJORAFFECT + catpclR + catpclN + catpclA + catpclAA + catpclDA, 
                   data = pclNoNa)
ggforest(fit.coxphPCL, data = pclNoNa)
```

```{r}
# Binomial regression

model1 <- glm(MONTH2 ~ scale(pclR) + scale(pclA) + scale(pclN) + scale(pclDA) + scale(pclAA) + AGE_OCT01 + VAXTM, data=pclNoNa  )
summary(model1)
```


