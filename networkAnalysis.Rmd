---
title: "R Notebook"
output: html_notebook
---
In this script I try to do network analysis on symptoms of PTSD and PHQ (depression) in the VA database.
This is based on these papers:
https://psycnet.apa.org/record/2018-13501-001?doi=1
https://www.sciencedirect.com/science/article/pii/S0887618516302419?via%3Dihub#upi0010
 
```{r}
library(bootnet)
require(tidyverse)
```

```{r}
# Addind time difference between PCL and PHQ
pclNetwork <- pclNoNa
a = '01/01/1960'


pclNetwork$PCL_PHQdiff <- pclNetwork$PCLSURVEYDATE - pclNetwork$PHQSURVEYDATE
pclNetwork <- filter(pclNetwork, PCL_PHQdiff <= 14 & PCL_PHQdiff >= -14) # removing patients with more than 14 apart between PHQ9 and PCL-M
#pclNetwork$PCL_PHQdiff <- (as.Date(as.character(a), format = '%d/%m/%Y') + pclNetwork$PCLSURVEYDATE) - (as.Date(as.character(a), format = '%d/%m/%Y') + pclNetwork$PHQSURVEYDATE)
```

```{r}
# build data set only with PCL items
pclItems <- select(pclNetwork, starts_with("PCL"))
```


```{r}
pclItems_noCluster <- select(pclItems, -pclN, -pclR, -pclDA, -pclA, -pclAA, -PCLFY, -PCLSURVEYDATE, -PCLRAWSCORE, -PCL_PHQdiff)
pclItems_noCluster <- na.omit(pclItems_noCluster)
results_noCluster <- estimateNetwork(pclItems_noCluster,
default = "EBICglasso",
corMethod = "cor_auto",
tuning = 0.5)
```

```{r}
# create five factor pcl scores
# 1-5 Reexpirienceing (R)
# 6-7 avoidance (A)
# 8-12 emotional numbing (N)
# 13-15 dysphoric arousal (DA)
# 16-17 Anxios arousal (AA)
gr1 <- list("Reexpirienceing"=c(1:5), "Avoidance"=c(6:7), "Emotional numbing"=c(8:12),"Dysphoric arousal"=c(13:15), "Anxios arousal"=c(16:17)) #PTSD Clusters
gr_likeDSM <- list("Intrusion"=c(1:5), "Avoidance"=c(6:12), "Arousal"=c(13:17)) #PTSD symptoms categories B C D
plot(results_noCluster, groups = gr1, theme="colorblind")
plot(results_noCluster, groups = gr_likeDSM)
```

```{r}
library(qgraph)
centrality(results_noCluster)
centralityPlot(results_noCluster, include = "all")
```
## When analyzing only PCL network the 10th item (Feeling distant or cut off from other people) is the most central. 
```{r}
# bootstrapping to assess stability of network
#boot1 <- bootnet(results_noCluster, nCores = 8, nBoots = 1000, type = "nonparametric") 
#boot2 <- bootnet(results_noCluster, nCores = 8, nBoots = 1000, type = "case")
```

```{r}
plot(boot2, labels = F, order = "sample")  + theme_minimal()
```
Now second network
```{r}
pclItems2 <- select(pclNetwork, starts_with("PCL"),  -pclN, -pclR, -pclDA, -pclA, -pclAA, -PCLFY, -PCLSURVEYDATE, -PCLRAWSCORE, PHQ1,PHQ2,PHQ3, PHQ4,PHQ5,PHQ6,PHQ7,PHQ8,PHQ9,-PCL_PHQdiff)
pclItems2 <- na.omit(pclItems2) # removes any NAs
```

```{r}
results_Net2 <- estimateNetwork(pclItems2,
default = "EBICglasso",
corMethod = "cor_auto",
threshold = TRUE,
tuning = 0.5)
```
```{r}
# get location of PHQ-9 questions
grep("PHQ", colnames(pclItems2))
gr2 <- list("Reexpirienceing"=c(1:5), "Avoidance"=c(6:7), "Emotional numbing"=c(8:12),"Dysphoric arousal"=c(13:15), "Anxios arousal"=c(16:17), "PHQ9-Depression"=c(18:26)) #PTSD symptoms categories B C D E  
plot(results_Net2, groups = gr2, cut=0, maximum=.5, minimum=.03)
```

```{r}
centralityPlot(results_Net2, include = "all")
# check level of cenrality
sort(centrality(results_Net2)$OutDegree, decreasing = T)
```
## Maybe we should compare the netwrok of medicated vs. non medication patients
```{r}
noMed_dat <- subset(vaDatclean, vaDatclean$PMEDRX==0)
pclNoMed <- filter(noMed_dat, !is.na(BPCLTOT))
# remove patients with more than 14 days apart PHQ and PCL
pclNoMed$PCL_PHQdiff <- pclNoMed$PCLSURVEYDATE - pclNoMed$PHQSURVEYDATE
pclNoMed <- filter(pclNoMed, PCL_PHQdiff <= 14 & PCL_PHQdiff >= -14)

pclNoMed_Network <- select(pclNoMed, starts_with("PCL"), -PCLFY, -PCLSURVEYDATE, -PCLRAWSCORE, PHQ1,PHQ2,PHQ3, PHQ4,PHQ5,PHQ6,PHQ7,PHQ8,PHQ9, -PCL_PHQdiff)
pclNoMed_Network <- na.omit(pclNoMed_Network) # remove any NAs
```
```{r}
results_NoMed <- estimateNetwork(pclNoMed_Network,
default = "EBICglasso",
corMethod = "cor_auto",
threshold = TRUE,
tuning = 0.5)
```

```{r}
# get location of PHQ-9 questions
grep("PHQ", colnames(pclNoMed_Network))
grep("PCL", colnames(pclNoMed_Network))
gr3 <- list("Reexpirienceing"=c(1:5), "Avoidance"=c(6:7), "Emotional numbing"=c(8:12),"Dysphoric arousal"=c(13:15), "Anxios arousal"=c(16:17), "PHQ9-Depression"=c(18:26)) #PTSD symptoms categories B C D E
plot(results_NoMed, groups = gr3,  cut=0, maximum=.5, minimum=.03)
```
```{r}
sort(centrality(results_NoMed)$OutDegree, decreasing = T)
centralityPlot(results_NoMed, include = "all")
centralityPlot(list("Without medication" = results_NoMed, "With Medication" = results_Net2), include = c("Betweenness", "Strength", "Closeness", "ExpectedInfluence"), decreasing = TRUE) + theme_minimal() 
```
## In both graphs seems like sleep disturbances plays a crucial role in the network. 
### We also see the 2-factor model of depression (somatic and non somatic symptoms) - worth reporting also in publication. 

Lets compare the two netwroks by substracting one from the other and see if there is something else

```{r netComparison}
# building the matrices
data_ptsdMed<-cor_auto(pclItems2) #only ptsd symptoms
data_ptsdNoMed<-cor_auto(pclNoMed_Network) #data including covariates
# run EBIC GLASSO
model1Meds <-EBICglasso(data_ptsdMed, n = nrow(pclItems2))
model2NoMeds <-EBICglasso(data_ptsdNoMed, n = nrow(pclNoMed_Network))

min(model1Meds)
# graph medicated patients
qgraph(model1Meds, layout="spring", cut=0, maximum=.6, 
       minimum=.03, theme = "colorblind",
       groups=gr3,legend.cex=.4)
# graph unmedicated
qgraph(model2NoMeds, layout="spring", cut=0, maximum=.6, 
       minimum=.03, theme = "colorblind",
       groups=gr3,legend.cex=.4)



delta <- model1Meds - model2NoMeds # comparing the two networks

max(delta)
mean(abs(delta[upper.tri(delta,diag=FALSE)]))

colnames(delta)<-rownames(delta)<-c(1:26)

L<-averageLayout(model1Meds) # use same layout as Figure 1
#pdf("Fig4.pdf", width=9, height=7)
# name for labeling
names = c("PCL1","PCL2","PCL3","PCL4","PCL5","PCL6","PCL7","PCL8","PCL9","PCL10","PCL11","PCL12","PCL13","PCL14","PCL15","PCL16","PCL17","PHQ1","PHQ2","PHQ3","PHQ4","PHQ5","PHQ6","PHQ7","PHQ8","PHQ9")
qgraph(delta, labels = names, layout=L, vsize=6, cut=0, maximum=.5, 
       border.width=1.5, border.color="black", minimum=.03, 
       groups=gr3,legend.cex=.4, theme = "colorblind")
cor(as.vector(model2NoMeds),as.vector(model1Meds), method="spearman") #0.96
```
## From this comparison we can see that there is very small, if any, difference between the two models (with medications or without)
### The correlation between the two graphs (with or without medications) is 0.96 - which also suggests that there is negligble difference bwteen the two
### The maximum (highest) correlation in these delta graph (the difference between the two other graphs) is 0.036

Now we can also compare the network with and without PHQ
```{r dep_yesNo}
modelDep <- model1Meds[-c(18:26), -c(18:26)] # creates the network matrix of depression but omitting the actual depression variables

data_ptsd<-cor_auto(pclItems_noCluster) #only ptsd symptoms

modelNoDep <-EBICglasso(data_ptsd, n = nrow(pclItems_noCluster))

deltaDep <- modelDep - modelNoDep
max(deltaDep)
mean(abs(deltaDep[upper.tri(deltaDep,diag=FALSE)]))

cor(as.vector(modelDep),as.vector(modelNoDep), method="spearman") #0.99
```

```{r}
#Compare using NTC
# Medicated vs. unmedicated patients
require(NetworkComparisonTest)
set.seed(1337)
pclNoMed_na <- na.omit(pclNoMed_Network)
pclItem_na <- na.omit(pclItems2)
compare_12 <- NCT(pclItem_na,pclNoMed_na, it=5000, binary.data=FALSE, test.edges=TRUE, edges='all', progressbar=TRUE, test.centrality = TRUE, centrality=c("strength","betweenness", "closeness"), p.adjust.methods = "fdr")
```

```{r}
compare_12$nwinv.pval

table(compare_12$einv.pvals$"p-value" < 0.05) # how many edges are less than p=0.05 
# two edges - lets subset that
sigEdge <- subset(compare_12$einv.pvals, compare_12$einv.pvals$`p-value`<0.05)


compare_12$glstrinv.pval # strength of network
compare_12$glstrinv.real
compare_12$einv.real

compare_12$diffcen.pval
compare_12$diffcen.real
plot(compare_12, what = "network") 
# there is a difference between networks
plot(compare_12, what = "strength")
# no diff
plot(compare_12, what = "edge")

# two edges were found to be different. 12-15 and 12-20 (i.e. phq3)
# lets look at each of them in the network:
results_Net2$results
# PCL13 - PHQ8  0.0 (graph results)
# PHQ1 - PHQ8 0.0
# Correlations:
# 0.28
# 0.36
results_NoMed$results
# PCL13 - PHQ8  0.0
# PHQ1 - PHQ8 0.07
# Correlations:
# 0.33
# 0.42

```
## Lets see cluters
```{r}
# Here we use a method that was described in the following link to resulve cluster issues in graph theory.
# https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0174035
# 
# library(EGAnet)
# ega<-EGA(pclItems2, plot.EGA = TRUE, steps = 4)
# ega<-EGA(pclNoMed_Network, plot.EGA = TRUE, steps = 1) # here they find the four clusters like DSM
```

## Running 2 steps EGA scales to 4 factors. Running 4 steps scales to three factors. 


## Some descriptive statistics
```{r desc}
names(pclNetwork)
table(pclNetwork$ADRXN_true)
# 13218 with Antidepressants (93%)
table(pclNoMed$ADRXN_true)

```
## Do sample descriptives
```{r sample descriptives}
# gather info on both meds and no meda
pclAll <- dplyr::filter(vaDatclean, !is.na(BPCLTOT))
# remove patients with more than 14 days apart PHQ and PCL
pclAll$PCL_PHQdiff <- pclAll$PCLSURVEYDATE - pclAll$PHQSURVEYDATE
pclAll <- dplyr::filter(pclAll, PCL_PHQdiff <= 14 & PCL_PHQdiff >= -14)
summary(pclAll$AGE_OCT01)
mean(pclAll$AGE_OCT01, na.rm=TRUE)
sd(pclAll$AGE_OCT01, na.rm=TRUE)
summary(pclAll$BPCLTOT)
mean(pclAll$BPCLTOT)
sd(pclAll$BPCLTOT)

summary(pclAll$PHQSUMTOTAL)
mean(pclAll$PHQSUMTOTAL, na.rm=TRUE)
sd(pclAll$PHQSUMTOTAL, na.rm=TRUE)


```

## Play with Bnlearn package - for Baysian network analysis (causality/directions) --> Directed acyclic graph (DAG)

```{r}
require(bnlearn)
require(Rgraphviz)

## Hill Climbing Algorithm-- Bayesian network learned via Score-based methods & network averaging (bootstrap based)
set.seed(123)
bootnet <- bnlearn::boot.strength(pclItems2, R = 1000, algorithm = "hc", algorithm.args = list(restart = 5, perturb = 10), debug = TRUE, cpdag = TRUE)
head(bootnet)

## net1: use the optimal cutpoint according to Scurati & Nagarajan (2013) 
avgnet1 <- bnlearn::averaged.network(bootnet)
avgnet1      
bnlearn::score(avgnet1, data =pclItems2)
thresh <- avgnet1$learning$args[[1]]
thresh                                  ## optimal significance threshold
astr1 <- bnlearn::arc.strength(avgnet1,pclItems2, "bic-g")   ## compute edge strengths
astr1
order(astr1)
sortedAstr = astr1[order(astr1$strength),]
##plot DAG

suppressWarnings(bnlearn::strength.plot(avgnet1, astr1, shape = "ellipse", threshold = thresh))

## Save DAG as a PDF
postscript("Figure4.ps", width = 12)
suppressWarnings(bnlearn::strength.plot(avgnet1, astr1, shape = "ellipse", threshold = thresh))
dev.off()
# learn
#dg <- hc(pclItems2)
#########################################################################################################################################################################################
######################################################## USING Mcnally 2017 full method:#################################################################################################
######################################################################################################################################################################################### 
## filter the ones with a strength larger than 0.85 and a direction probability > 0.5
bootnet[bootnet$strength > 0.85 & bootnet$direction > 0.5, ]

## net1: build the average network using a 0.85 threshold (Sachs et al., 2005)
avgnet1 <- averaged.network(bootnet, threshold = 0.85)
avgnet1
bnlearn::score(avgnet1, data = pclItems2)
astr1 <- arc.strength(avgnet1, pclItems2, "bic-g")   ## compute edge strengths

strength.plot(avgnet1, astr1, shape = "ellipse")

## net2: use the optimal cutpoint, according to Scurati & Nagarajan (2013)
avgnet2 <- averaged.network(bootnet)
avgnet2      
bnlearn::score(avgnet2, data = pclItems2)
thresh <- avgnet2$learning$args[[1]]
thresh                                  ## optimal significance threshold
astr2 <- arc.strength(avgnet2, pclItems2, "bic-g")   ## compute edge strengths
astr2

suppressWarnings(strength.plot(avgnet2, astr2, shape = "ellipse", threshold = 0.5))

## net3: use net2 threshold, edge strenghts are determined by direction probability
boottab <- bootnet[bootnet$strength > thresh & bootnet$direction > 0.5, ]  ## edges in net2
boottab
astr3 <- boottab   ## table with direction probabilities
astr3$strength <- astr3$direction  ## use the direction probabilities for edge width

strength.plot(avgnet2, astr3, shape = "ellipse")
## thick arrows indicate high directional probabilties, thin arrows low directional probabilities

## net4: use net1 threshold, edge strenghts are determined by direction probability
boottab <- bootnet[bootnet$strength > 0.85 & bootnet$direction > 0.5, ]  ## edges in net2
boottab
astr4 <- boottab   ## table with direction probabilities
astr4$strength <- astr4$direction  ## use the direction probabilities for edge width

strength.plot(avgnet1, astr4, shape = "ellipse")
## thick arrows indicate high directional probabilties, thin arrows low directional probabilities
######## 
```
### Intrusion symptoms are the cause of everything else basically


```{r}
# if (!requireNamespace("BiocManager", quietly=TRUE))
#     install.packages("BiocManager")
# BiocManager::install('Rgraphviz')

```



