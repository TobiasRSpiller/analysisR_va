---
title: "Note book for analysis of network of pcl and PHQ9 scores"
output: html_notebook
---

```{r}
library(bootnet)
require(tidyverse)
require("corrplot")       ## correlation matrix plots

```

```{r}
# Addind time difference between PCL and PHQ
# gather info on both meds and no meda

# all patientes with PTSD and PCLTOT
pclAll <- dplyr::filter(vaDatclean, !is.na(BPCLTOT))
# plot pcl total score 
hist(pclAll$BPCLTOT)
# we have a minimum of 2 - so we have some NAs - let remove them
pclAll_Nas <- filter(pclAll, BPCLTOT <=16)
# total of 20 subjects with 16 or less in PCL (i.e. at least one missing variable)
# we can remove them from analysis
pclAll <- filter(pclAll, BPCLTOT >=17)
# 159577 patients
#pclNetwork <- pclNoNa # just medicated
pclNetwork <- pclAll
nrow(pclNetwork)
hist(pclNetwork$BPCLTOT)

pclNetwork$PCL_PHQdiff <- pclNetwork$PHQSURVEYDATE - pclNetwork$PCLSURVEYDATE
pclPHQNetwork <- filter(pclNetwork, PCL_PHQdiff <= 14 & PCL_PHQdiff >= 0) # removing patients with more than 14 apart between PHQ9 and PCL-M
pclPHQNetwork <- filter(pclPHQNetwork, BPCLTOT>=17)
hist(pclPHQNetwork$PCL_PHQdiff)
```

```{r}
# build data set only with PCL items
pclItems <- select(pclAll, starts_with("PCL"))
pclPHQItems <- dplyr::select(pclPHQNetwork, starts_with("PCL"))
```


```{r}
pclItems_noCluster <- select(pclItems, -PCLFY, -PCLSURVEYDATE, -PCLRAWSCORE)
nrow(pclItems_noCluster)
pclItems_noCluster <- na.omit(pclItems_noCluster)
nrow(pclItems_noCluster)

results_noCluster <- estimateNetwork(pclItems_noCluster,
default = "EBICglasso",
corMethod = "cor_auto",
tuning = 0.5)
```

```{r}
# create five factor pcl scores
# 1-5 Reexpirienceing (R)
# 6-7 avoidance (A)
# 8-12 emotional numbing (N)
# 13-15 dysphoric arousal (DA)
# 16-17 Anxios arousal (AA)
gr1 <- list("Reexpirienceing"=c(1:5), "Avoidance"=c(6:7), "Emotional numbing"=c(8:12),"Dysphoric arousal"=c(13:15), "Anxios arousal"=c(16:17)) #PTSD Clusters
gr_likeDSM <- list("Intrusion"=c(1:5), "Avoidance"=c(6:12), "Arousal"=c(13:17)) #PTSD symptoms categories B C D
plot(results_noCluster, groups = gr1, theme="colorblind")
plot(results_noCluster, groups = gr_likeDSM)
```

```{r}
library(qgraph)
# sort by level of centrality (strength)
sort(centrality(results_noCluster)$OutDegree, decreasing = T)
# plot centrality
centralityPlot(results_noCluster, include = "all")
```

## TO check net stability we run two bootsrap procedures - on edges and on subject
```{r}
# Bootstrap 1:
#boot1 <- bootnet(results_noCluster, nCores = 8, nBoots = 1000, type = "nonparametric") 
plot(boot1, labels = F, order = "sample")  + theme_minimal()
# now lets look at subjects
#boot2 <- bootnet(results_noCluster, nCores = 10, nBoots = 1000, type = "case")
plot(boot2, labels = F, order = "sample") + theme_minimal()
```


## Here we took 63k patients with PTSD and ran network analysis. We can see that PCL-4 scores 

## Do sample descriptives on all subjects
```{r sample descriptives}
# gather info on both meds and no meda
# remove patients with more than 14 days apart PHQ and PCL
summary(pclAll$AGE_OCT01)
mean(pclAll$AGE_OCT01, na.rm=TRUE)
sd(pclAll$AGE_OCT01, na.rm=TRUE)
summary(pclAll$BPCLTOT)
mean(pclAll$BPCLTOT)
sd(pclAll$BPCLTOT)

summary(pclPHQNetwork$PHQSUMTOTAL)
mean(pclPHQNetwork$PHQSUMTOTAL, na.rm=TRUE)
sd(pclPHQNetwork$PHQSUMTOTAL, na.rm=TRUE)


```

## Use PHQ and PCL (PHQ9 is 0-14 days from PCL)

```{r}
summary(pclPHQNetwork$PCL_PHQdiff)
# we see most patients filled PHQ same day as PCL

summary(pclPHQNetwork$PHQ1)

pclPHQNetwork_noCluster <- select(pclPHQNetwork, starts_with("PCL"), -PCLFY, -PCLSURVEYDATE, -PCLRAWSCORE, -PCL_PHQdiff, PHQ1,PHQ2,PHQ3, PHQ4,PHQ5,PHQ6,PHQ7,PHQ8,PHQ9)
pclPHQNetwork_noCluster <- na.omit(pclPHQNetwork_noCluster)

results_PHQnoCluster <- estimateNetwork(pclPHQNetwork_noCluster,
default = "EBICglasso",
corMethod = "cor_auto",
tuning = 0.5)

grep("PHQ", colnames(pclItems2)) # get location of PHQ
gr2 <- list("Reexpirienceing"=c(1:5), "Avoidance"=c(6:7), "Emotional numbing"=c(8:12),"Dysphoric arousal"=c(13:15), "Anxios arousal"=c(16:17), "PHQ9-Depression"=c(18:26)) #PTSD symptoms categories B C D E  
plot(results_PHQnoCluster, groups = gr2, theme="colorblind")
centralityPlot(results_PHQnoCluster, include = "all")
```

```{r}
## Take centrality measurements of this network
# sort by level of centrality (strength)
sort(centrality(results_PHQnoCluster)$OutDegree, decreasing = T)
# plot centrality
centralityPlot(results_PHQnoCluster, include = "all")
```

## Just to make sure its not a selection bias thing. Lets take the PCL_PHQ sample and build a graph just from PCL17 items
```{r}
pclPHQNetwork_justPCL <- select(pclPHQNetwork, starts_with("PCL"), -PCLFY, -PCLSURVEYDATE, -PCLRAWSCORE, -PCL_PHQdiff)

results_onlyPCL <- estimateNetwork(pclPHQNetwork_justPCL,
default = "EBICglasso",
corMethod = "cor_auto",
tuning = 0.5)

# plot
plot(results_onlyPCL, groups = gr2, theme="colorblind")
# sort centrality
sort(centrality(results_onlyPCL)$OutDegree, decreasing = T)
```


## compare centrality between the two networks
```{r}
centralityPlot(list("Only PCL" = results_noCluster, "PCL_PHQ9" = results_PHQnoCluster, "onlyPCL_PHQ_data" = results_onlyPCL), include = c("Betweenness", "Strength", "Closeness", "ExpectedInfluence"), decreasing = TRUE) + theme_minimal() 
```
## Now we will run DAG on each of the 2 networks. Starting with only PCL

```{r}
require(bnlearn)
require(Rgraphviz)
# we start with just PCL
## Hill Climbing Algorithm-- Bayesian network learned via Score-based methods & network averaging (bootstrap based)
set.seed(123)
netDat <- sample_n(pclItems_noCluster, 5000) # randomly sample 3k subjects - works with this amount but not with 150k
#pclPHQ_onlyPCL <- na.omit(pclPHQNetwork_justPCL)
bootnet <- bnlearn::boot.strength(netDat, R = 1000, algorithm = "hc", algorithm.args = list(restart = 5, perturb = 10), debug = TRUE, cpdag = TRUE)
head(bootnet)

## net1: use the optimal cutpoint according to Scurati & Nagarajan (2013) 
avgnet1 <- bnlearn::averaged.network(bootnet)
avgnet1      
bnlearn::score(avgnet1, data= netDat)
thresh <- avgnet1$learning$args[[1]]
thresh                                  ## optimal significance threshold
astr1 <- bnlearn::arc.strength(avgnet1,pclItems_noCluster, "bic-g")   ## compute edge strengths
astr1
order(astr1)
sortedAstr = astr1[order(astr1$strength),]
##plot DAG

suppressWarnings(bnlearn::strength.plot(avgnet1, astr1, shape = "ellipse", threshold = thresh))

## Save DAG as a PDF
postscript("Figure4.ps", width = 12)
suppressWarnings(bnlearn::strength.plot(avgnet1, astr1, shape = "ellipse", threshold = thresh))
dev.off()
```
## Run network comparison 
```{r}
#Compare using NTC
# Medicated vs. unmedicated patients
require(NetworkComparisonTest)
set.seed(1337)
# comparing the two networks (removing all PHQ items from the depression + PTSD network to create same sized matrices)
compare_12 <- NCT(results_noCluster$graph,results_PHQnoCluster$graph[1:17,1:17], it=5000, binary.data=FALSE, test.edges=TRUE, edges='all', progressbar=TRUE, test.centrality = TRUE, centrality=c("strength","betweenness", "closeness"), p.adjust.methods = "fdr")
```

```{r}
compare_12$nwinv.pval

table(compare_12$einv.pvals$"p-value" < 0.05) # how many edges are less than p=0.05 

sigEdge <- subset(compare_12$einv.pvals, compare_12$einv.pvals$`p-value`<0.05)


compare_12$glstrinv.pval # strength of network
compare_12$glstrinv.real
compare_12$einv.real

compare_12$diffcen.pval
compare_12$diffcen.real
plot(compare_12, what = "network") 
# there is a difference between networks
plot(compare_12, what = "strength")
# no diff
plot(compare_12, what = "edge")

# two edges were found to be different. 12-15 and 12-20 (i.e. phq3)
# lets look at each of them in the network:
results_Net2$results
# PCL13 - PHQ8  0.0 (graph results)
# PHQ1 - PHQ8 0.0
# Correlations:
# 0.28
# 0.36
results_NoMed$results
# PCL13 - PHQ8  0.0
# PHQ1 - PHQ8 0.07
# Correlations:
# 0.33
# 0.42

```

